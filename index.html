<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Armada - Full Progres</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #3498db; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --light: #f8f9fa;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #dfe6e9; margin: 0; padding: 10px; }
        
        .tab-menu {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 0;
            position: sticky; top: 0; background: #dfe6e9; z-index: 100; justify-content: center;
        }
        .btn-tab {
            background: white; border: 2px solid var(--primary); color: var(--primary);
            padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;
            flex: 1 1 calc(25% - 10px); min-width: 70px; text-align: center; font-size: 0.8em;
        }
        .btn-tab.active { background: var(--primary); color: white; }

        /* Tombol Progres mencakup semua status kerja */
        .btn-repair { border-color: var(--danger); color: var(--danger); flex: 1 1 48%; }
        .btn-repair.active { background: var(--danger); color: white; }
        .btn-history { border-color: var(--success); color: var(--success); flex: 1 1 48%; }
        .btn-history.active { background: var(--success); color: white; }

        .sub-menu {
            display: flex; justify-content: center; gap: 10px; margin: 10px 0;
            background: white; padding: 10px; border-radius: 12px;
        }
        .btn-sub {
            background: #eee; border: 1px solid #ccc; padding: 8px 15px;
            border-radius: 20px; cursor: pointer; font-weight: bold; flex: 1;
        }
        .btn-sub.active { background: var(--accent); color: white; border-color: var(--accent); }

        .table-container { background: white; border-radius: 12px; padding: 10px; overflow-x: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        .bus-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .bus-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 6px solid #ccc; }
        
        .status-badge { padding: 4px 8px; border-radius: 5px; font-size: 0.7em; font-weight: bold; float: right; text-transform: uppercase; }
        .status-menunggu { background: #fff3e0; color: #e65100; } 
        .status-service { background: #e3f2fd; color: #0d47a1; }  
        .status-perbaikan { background: #ffebee; color: #b71c1c; } 

        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="tab-menu">
    <button class="btn-tab active" onclick="changeMain('1', this)">TP 1</button>
    <button class="btn-tab" onclick="changeMain('2', this)">TP 2</button>
    <button class="btn-tab" onclick="changeMain('3', this)">TP 3</button>
    <button class="btn-tab" onclick="changeMain('4', this)">TP 4</button>
    <button class="btn-tab" onclick="changeMain('BS', this)">BS</button>
    <button class="btn-tab" onclick="changeMain('CAD', this)">CAD</button>
    <button class="btn-tab btn-repair" onclick="changeMain('REPAIR', this)">üõ†Ô∏è PROGRES</button>
    <button class="btn-tab btn-history" onclick="changeMain('HISTORY', this)">üìä REKAP SELESAI</button>
</div>

<div class="sub-menu" id="subMenu"></div>
<div id="contentArea"></div>

<script>
    const storageKey = "db_bus_v16_progres";
    let mainFilter = '1';
    let subFilter = 'A';

    const STATUS_LIST = ["Menunggu Part", "Service", "Dalam Perbaikan"];

    function initData() {
        let buses = [];
        for(let r=1; r<=3; r++){
            ['A', 'B'].forEach(g => {
                for(let n=1; n<=3; n++) buses.push({id:`TP${r}${g}${n}`, kode:`TP ${r}${g}-0${n}`, route:r.toString(), group:g, status:'Service', kerusakan:[], riwayat:[]});
            });
        }
        ['A', 'B', 'C'].forEach(g => {
            for(let n=1; n<=2; n++) buses.push({id:`TP4${g}${n}`, kode:`TP 4${g}-0${n}`, route:'4', group:g, status:'Service', kerusakan:[], riwayat:[]});
        });
        for(let i=1; i<=5; i++) buses.push({id:`BS${i}`, kode:`BS ${i}`, route:'BS', group:'ALL', status:'Service', kerusakan:[], riwayat:[]});
        for(let i=1; i<=2; i++) buses.push({id:`CAD${i}`, kode:`CAD ${i}`, route:'CAD', group:'ALL', status:'Service', menggantikan:'', kerusakan:[], riwayat:[]});
        return buses;
    }

    let dataBus = JSON.parse(localStorage.getItem(storageKey)) || initData();
    function save() { localStorage.setItem(storageKey, JSON.stringify(dataBus)); }

    function updateSubMenu() {
        const sub = document.getElementById('subMenu');
        if (['BS', 'CAD', 'REPAIR', 'HISTORY'].includes(mainFilter)) { sub.style.display = 'none'; return; }
        sub.style.display = 'flex';
        let grps = (mainFilter === '4') ? ['A', 'B', 'C'] : ['A', 'B'];
        if (mainFilter !== '4' && subFilter === 'C') subFilter = 'A';
        sub.innerHTML = grps.map(g => `<button class="btn-sub ${subFilter===g?'active':''}" onclick="changeSub('${g}')">Grup ${g}</button>`).join('');
    }

    function changeMain(v, btn) {
        mainFilter = v;
        document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateSubMenu(); render();
    }

    function changeSub(v) { subFilter = v; updateSubMenu(); render(); }

    function render() {
        const area = document.getElementById('contentArea');
        area.innerHTML = '';

        if (mainFilter === 'HISTORY') {
            let html = `<div class="table-container"><table><thead><tr><th>Kode Bus</th><th>Catatan Kerusakan</th><th>Waktu Selesai</th></tr></thead><tbody>`;
            dataBus.forEach(b => b.riwayat.forEach(r => {
                html += `<tr><td><strong>${b.kode}</strong></td><td>${r.ket}</td><td>${r.tgl}</td></tr>`;
            }));
            area.innerHTML = html + `</tbody></table></div>`;
            return;
        }

        let filtered = dataBus;
        if (mainFilter === 'REPAIR') {
            // Menu PROGRES sekarang menampilkan semua bus yang statusnya Menunggu Part, Service, ATAU Dalam Perbaikan
            // Dan yang memiliki minimal 1 item kerusakan
            filtered = dataBus.filter(b => b.kerusakan.length > 0);
        } else if (['BS', 'CAD'].includes(mainFilter)) {
            filtered = dataBus.filter(b => b.route === mainFilter);
        } else {
            filtered = dataBus.filter(b => b.route === mainFilter && b.group === subFilter);
        }

        let grid = document.createElement('div');
        grid.className = 'bus-grid';
        
        filtered.forEach(bus => {
            const card = document.createElement('div');
            card.className = 'bus-card';
            
            let borderColor = 'var(--warning)';
            let statusClass = 'status-menunggu';
            if(bus.status === 'Service') { borderColor = 'var(--accent)'; statusClass = 'status-service'; }
            if(bus.status === 'Dalam Perbaikan') { borderColor = 'var(--danger)'; statusClass = 'status-perbaikan'; }
            card.style.borderLeftColor = borderColor;
            
            let cadHTML = (bus.route === 'CAD') ? `<select onchange="uBus('${bus.id}','menggantikan',this.value)"><option value="">-- Ganti Bus --</option>${dataBus.filter(x=>x.route!=='CAD').map(x=>`<option value="${x.kode}" ${bus.menggantikan===x.kode?'selected':''}>${x.kode}</option>`).join('')}</select>` : '';

            card.innerHTML = `
                <div class="bus-header">
                    <span class="status-badge ${statusClass}">${bus.status}</span>
                    <span style="font-weight:bold">${bus.kode}</span>
                </div>
                <select onchange="uBus('${bus.id}','status',this.value)">
                    <option value="Menunggu Part" ${bus.status==='Menunggu Part'?'selected':''}>‚è≥ Menunggu Part</option>
                    <option value="Service" ${bus.status==='Service'?'selected':''}>üõ†Ô∏è Service</option>
                    <option value="Dalam Perbaikan" ${bus.status==='Dalam Perbaikan'?'selected':''}>‚öôÔ∏è Dalam Perbaikan</option>
                </select>
                ${cadHTML}
                <div style="background:#fff9c4; padding:10px; border-radius:8px; margin-top:8px">
                    ${bus.kerusakan.map((k, i) => `<div style="display:flex; justify-content:space-between; margin:4px 0; font-size:0.85em"><span>‚Ä¢ ${k}</span><button onclick="done('${bus.id}',${i})" style="background:var(--success); color:white; border:none; padding:2px 8px; border-radius:4px">Selesai</button></div>`).join('') || '<p style="font-size:0.8em; color:#777">Kondisi Aman</p>'}
                    <input type="text" id="in-${bus.id}" placeholder="Input kerusakan..."><button class="btn-add" onclick="add('${bus.id}')">SIMPAN</button>
                </div>`;
            grid.appendChild(card);
        });
        area.appendChild(grid);
    }

    function uBus(id, k, v) { dataBus.find(x => x.id === id)[k] = v; save(); render(); }
    function add(id) { 
        const input = document.getElementById(`in-${id}`);
        if(!input.value) return;
        dataBus.find(x => x.id === id).kerusakan.push(input.value);
        input.value = ''; save(); render();
    }
    function done(id, idx) {
        const b = dataBus.find(x => x.id === id);
        const ket = b.kerusakan.splice(idx, 1);
        b.riwayat.push({ tgl: new Date().toLocaleString('id-ID',{dateStyle:'short',timeStyle:'short'}), ket: ket[0] });
        save(); render();
    }
    updateSubMenu(); render();
</script>
</body>
</html>
